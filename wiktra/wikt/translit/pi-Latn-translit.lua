-- For Lao script, see https://www.unicode.org/charts/PDF/U0E80.pdf (Unicode 12.0+)
local export = {}
local gsub = mw.ustring.gsub
local match = mw.ustring.match
local sub = mw.ustring.sub
local u = mw.ustring.char

local c = {
    ["Deva"] = {["k"] = "à¤•", ["kh"] = "à¤–", ["g"] = "à¤—", ["gh"] = "à¤˜", ["á¹…"] = "à¤™", ["c"] = "à¤š", ["ch"] = "à¤›", ["j"] = "à¤œ", ["jh"] = "à¤", ["Ã±"] = "à¤", ["á¹­"] = "à¤Ÿ", ["á¹­h"] = "à¤ ", ["á¸"] = "à¤¡", ["á¸h"] = "à¤¢", ["á¹‡"] = "à¤£", ["t"] = "à¤¤", ["th"] = "à¤¥", ["d"] = "à¤¦", ["dh"] = "à¤§", ["n"] = "à¤¨", ["p"] = "à¤ª", ["ph"] = "à¤«", ["b"] = "à¤¬", ["bh"] = "à¤­", ["m"] = "à¤®", ["y"] = "à¤¯", ["r"] = "à¤°", ["l"] = "à¤²", ["v"] = "à¤µ", ["s"] = "à¤¸", ["h"] = "à¤¹", ["á¸·"] = "à¤³", ["a"] = "à¤…", ["Ä"] = "à¤†", ["i"] = "à¤‡", ["Ä«"] = "à¤ˆ", ["u"] = "à¤‰", ["Å«"] = "à¤Š", ["e"] = "à¤", ["o"] = "à¤“", ["á¹ƒ"] = "à¤‚", [""] = ""},

    ["Beng"] = {["k"] = "à¦•", ["kh"] = "à¦–", ["g"] = "à¦—", ["gh"] = "à¦˜", ["á¹…"] = "à¦™", ["c"] = "à¦š", ["ch"] = "à¦›", ["j"] = "à¦œ", ["jh"] = "à¦", ["Ã±"] = "à¦", ["á¹­"] = "à¦Ÿ", ["á¹­h"] = "à¦ ", ["á¸"] = "à¦¡", ["á¸h"] = "à¦¢", ["á¹‡"] = "à¦£", ["t"] = "à¦¤", ["th"] = "à¦¥", ["d"] = "à¦¦", ["dh"] = "à¦§", ["n"] = "à¦¨", ["p"] = "à¦ª", ["ph"] = "à¦«", ["b"] = "à¦¬", ["bh"] = "à¦­", ["m"] = "à¦®", ["y"] = "à¦¯", ["r"] = "à¦°", ["l"] = "à¦²", ["v"] = "à§°", ["s"] = "à¦¸", ["h"] = "à¦¹", ["á¸·"] = "à¦²à¦¼", ["a"] = "à¦…", ["Ä"] = "à¦†", ["i"] = "à¦‡", ["Ä«"] = "à¦ˆ", ["u"] = "à¦‰", ["Å«"] = "à¦Š", ["e"] = "à¦", ["o"] = "à¦“", ["á¹ƒ"] = "à¦‚", [""] = ""},

    ["Brah"] = {["k"] = "ğ‘€“", ["kh"] = "ğ‘€”", ["g"] = "ğ‘€•", ["gh"] = "ğ‘€–", ["á¹…"] = "ğ‘€—", ["c"] = "ğ‘€˜", ["ch"] = "ğ‘€™", ["j"] = "ğ‘€š", ["jh"] = "ğ‘€›", ["Ã±"] = "ğ‘€œ", ["á¹­"] = "ğ‘€", ["á¹­h"] = "ğ‘€", ["á¸"] = "ğ‘€Ÿ", ["á¸h"] = "ğ‘€ ", ["á¹‡"] = "ğ‘€¡", ["t"] = "ğ‘€¢", ["th"] = "ğ‘€£", ["d"] = "ğ‘€¤", ["dh"] = "ğ‘€¥", ["n"] = "ğ‘€¦", ["p"] = "ğ‘€§", ["ph"] = "ğ‘€¨", ["b"] = "ğ‘€©", ["bh"] = "ğ‘€ª", ["m"] = "ğ‘€«", ["y"] = "ğ‘€¬", ["r"] = "ğ‘€­", ["l"] = "ğ‘€®", ["v"] = "ğ‘€¯", ["s"] = "ğ‘€²", ["h"] = "ğ‘€³", ["á¸·"] = "ğ‘€´", ["a"] = "ğ‘€…", ["Ä"] = "ğ‘€†", ["i"] = "ğ‘€‡", ["Ä«"] = "ğ‘€ˆ", ["u"] = "ğ‘€‰", ["Å«"] = "ğ‘€Š", ["e"] = "ğ‘€", ["o"] = "ğ‘€‘", ["á¹ƒ"] = "ğ‘€", [""] = ""},

    ["Khmr"] = {["k"] = "á€", ["kh"] = "á", ["g"] = "á‚", ["gh"] = "áƒ", ["á¹…"] = "á„", ["c"] = "á…", ["ch"] = "á†", ["j"] = "á‡", ["jh"] = "áˆ", ["Ã±"] = "á‰", ["á¹­"] = "áŠ", ["á¹­h"] = "á‹", ["á¸"] = "áŒ", ["á¸h"] = "á", ["á¹‡"] = "á", ["t"] = "á", ["th"] = "á", ["d"] = "á‘", ["dh"] = "á’", ["n"] = "á“", ["p"] = "á”", ["ph"] = "á•", ["b"] = "á–", ["bh"] = "á—", ["m"] = "á˜", ["y"] = "á™", ["r"] = "áš", ["l"] = "á›", ["v"] = "áœ", ["s"] = "áŸ", ["h"] = "á ", ["á¸·"] = "á¡", ["a"] = "á¢", ["Ä"] = "á¢á¶", ["i"] = "á¥", ["Ä«"] = "á¦", ["u"] = "á§", ["Å«"] = "á¨", ["e"] = "á¯", ["o"] = "á²", ["á¹ƒ"] = "áŸ†", [""] = ""},

    ["Mymr"] = {["k"] = "á€€", ["kh"] = "á€", ["g"] = "á€‚", ["gh"] = "á€ƒ", ["á¹…"] = "á€„", ["c"] = "á€…", ["ch"] = "á€†", ["j"] = "á€‡", ["jh"] = "á€ˆ", ["Ã±"] = "á€‰", ["á¹­"] = "á€‹", ["á¹­h"] = "á€Œ", ["á¸"] = "á€", ["á¸h"] = "á€", ["á¹‡"] = "á€", ["t"] = "á€", ["th"] = "á€‘", ["d"] = "á€’", ["dh"] = "á€“", ["n"] = "á€”", ["p"] = "á€•", ["ph"] = "á€–", ["b"] = "á€—", ["bh"] = "á€˜", ["m"] = "á€™", ["y"] = "á€š", ["r"] = "á€›", ["l"] = "á€œ", ["v"] = "á€", ["s"] = "á€", ["h"] = "á€Ÿ", ["á¸·"] = "á€ ", ["a"] = "á€¡", ["Ä"] = "á€¡á€¬", ["i"] = "á€£", ["Ä«"] = "á€¤", ["u"] = "á€¥", ["Å«"] = "á€¦", ["e"] = "á€§", ["o"] = "á€©", ["á¹ƒ"] = "á€¶", [""] = ""},

    ["Sinh"] = {["k"] = "à¶š", ["kh"] = "à¶›", ["g"] = "à¶œ", ["gh"] = "à¶", ["á¹…"] = "à¶", ["c"] = "à¶ ", ["ch"] = "à¶¡", ["j"] = "à¶¢", ["jh"] = "à¶£", ["Ã±"] = "à¶¤", ["á¹­"] = "à¶§", ["á¹­h"] = "à¶¨", ["á¸"] = "à¶©", ["á¸h"] = "à¶ª", ["á¹‡"] = "à¶«", ["t"] = "à¶­", ["th"] = "à¶®", ["d"] = "à¶¯", ["dh"] = "à¶°", ["n"] = "à¶±", ["p"] = "à¶´", ["ph"] = "à¶µ", ["b"] = "à¶¶", ["bh"] = "à¶·", ["m"] = "à¶¸", ["y"] = "à¶º", ["r"] = "à¶»", ["l"] = "à¶½", ["v"] = "à·€", ["s"] = "à·ƒ", ["h"] = "à·„", ["á¸·"] = "à·…", ["a"] = "à¶…", ["Ä"] = "à¶†", ["i"] = "à¶‰", ["Ä«"] = "à¶Š", ["u"] = "à¶‹", ["Å«"] = "à¶Œ", ["e"] = "à¶‘", ["o"] = "à¶”", ["á¹ƒ"] = "à¶‚", [""] = ""},

    ["Thai"] = {
        ["k"] = "à¸",
        ["kh"] = "à¸‚",
        ["g"] = "à¸„",
        ["gh"] = "à¸†",
        ["á¹…"] = "à¸‡",
        ["c"] = "à¸ˆ",
        ["ch"] = "à¸‰",
        ["j"] = "à¸Š",
        ["jh"] = "à¸Œ",
        ["Ã±"] = "à¸",
        ["á¹­"] = "à¸",
        ["á¹­h"] = "à¸",
        ["á¸"] = "à¸‘",
        ["á¸h"] = "à¸’",
        ["á¹‡"] = "à¸“",
        ["t"] = "à¸•",
        ["th"] = "à¸–",
        ["d"] = "à¸—",
        ["dh"] = "à¸˜",
        ["n"] = "à¸™",
        ["p"] = "à¸›",
        ["ph"] = "à¸œ",
        ["b"] = "à¸",
        ["bh"] = "à¸ ",
        ["m"] = "à¸¡",
        ["y"] = "à¸¢",
        ["r"] = "à¸£",
        ["l"] = "à¸¥",
        ["v"] = "à¸§",
        ["s"] = "à¸ª",
        ["h"] = "à¸«",
        ["á¸·"] = "à¸¬",

        ["a"] = "à¸­",
        ["Ä"] = "à¸­à¸²",
        ["i"] = "à¸­à¸´",
        ["Ä«"] = "à¸­à¸µ",
        ["u"] = "à¸­à¸¸",
        ["Å«"] = "à¸­à¸¹",
        ["e"] = "à¸­à¹€", -- to be swapped later
        ["o"] = "à¸­à¹‚", -- to be swapped later

        ["á¹ƒ"] = "à¹",
        [""] = ""
    },

    ["Lana"] = {["k"] = "á¨ ", ["kh"] = "á¨¡", ["g"] = "á¨£", ["gh"] = "á¨¥", ["á¹…"] = "á¨¦", ["c"] = "á¨§", ["ch"] = "á¨¨", ["j"] = "á¨©", ["jh"] = "á¨«", ["Ã±"] = "á¨¬", ["á¹­"] = "á¨­", ["á¹­h"] = "á¨®", ["á¸"] = "á¨¯", ["á¸h"] = "á¨°", ["á¹‡"] = "á¨±", ["t"] = "á¨²", ["th"] = "á¨³", ["d"] = "á¨´", ["dh"] = "á¨µ", ["n"] = "á¨¶", ["p"] = "á¨·", ["ph"] = "á¨¹", ["b"] = "á¨»", ["bh"] = "á¨½", ["m"] = "á¨¾", ["y"] = "á¨¿", ["r"] = "á©", ["l"] = "á©ƒ", ["v"] = "á©…", ["s"] = "á©ˆ", ["h"] = "á©‰", ["á¸·"] = "á©Š", ["a"] = "á©‹", ["Ä"] = "á©‹á©£", ["i"] = "á©", ["Ä«"] = "á©", ["u"] = "á©", ["Å«"] = "á©", ["e"] = "á©‘", ["o"] = "á©‹á©°", ["á¹ƒ"] = "á©´", [""] = ""},

    ["Laoo"] = {
        ["k"] = "àº",
        ["kh"] = "àº‚",
        ["g"] = "àº„",
        ["gh"] = "àº†",
        ["á¹…"] = "àº‡",
        ["c"] = "àºˆ",
        ["ch"] = "àº‰",
        ["j"] = "àºŠ",
        ["jh"] = "àºŒ",
        ["Ã±"] = "àº",
        ["á¹­"] = "àº",
        ["á¹­h"] = "àº",
        ["á¸"] = "àº‘",
        ["á¸h"] = "àº’",
        ["á¹‡"] = "àº“",
        ["t"] = "àº•",
        ["th"] = "àº–",
        ["d"] = "àº—",
        ["dh"] = "àº˜",
        ["n"] = "àº™",
        ["p"] = "àº›",
        ["ph"] = "àºœ",
        ["b"] = "àº",
        ["bh"] = "àº ",
        ["m"] = "àº¡",
        ["y"] = "àº",
        ["r"] = "àº£",
        ["l"] = "àº¥",
        ["v"] = "àº§",
        ["s"] = "àºª",
        ["h"] = "àº«",
        ["á¸·"] = "àº¬",

        ["a"] = "àº­",
        ["Ä"] = "àº­àº²",
        ["i"] = "àº­àº´",
        ["Ä«"] = "àº­àºµ",
        ["u"] = "àº­àº¸",
        ["Å«"] = "àº­àº¹",
        ["e"] = "àº­à»€", -- to be swapped later
        ["o"] = "àº­à»‚", -- to be swapped later

        ["á¹ƒ"] = "à»",
        [""] = ""
    }

}

local v = {
    ["Deva"] = {["a"] = "", ["Ä"] = "à¤¾", ["i"] = "à¤¿", ["Ä«"] = "à¥€", ["u"] = "à¥", ["Å«"] = "à¥‚", ["e"] = "à¥‡", ["o"] = "à¥‹", [""] = ""},

    ["Beng"] = {["a"] = "", ["Ä"] = "à¦¾", ["i"] = "à¦¿", ["Ä«"] = "à§€", ["u"] = "à§", ["Å«"] = "à§‚", ["e"] = "à§‡", ["o"] = "à§‹", [""] = ""},

    ["Brah"] = {["a"] = "", ["Ä"] = "ğ‘€¸", ["i"] = "ğ‘€º", ["Ä«"] = "ğ‘€»", ["u"] = "ğ‘€¼", ["Å«"] = "ğ‘€½", ["e"] = "ğ‘‚", ["o"] = "ğ‘„", [""] = ""},

    ["Khmr"] = {["a"] = "", ["Ä"] = "á¶", ["i"] = "á·", ["Ä«"] = "á¸", ["u"] = "á»", ["Å«"] = "á¼", ["e"] = "áŸ", ["o"] = "áŸ„", [""] = ""},

    ["Mymr"] = {["a"] = "", ["Ä"] = "á€¬", ["i"] = "á€­", ["Ä«"] = "á€®", ["u"] = "á€¯", ["Å«"] = "á€°", ["e"] = "á€±", ["o"] = "á€±á€¬", [""] = ""},

    ["Sinh"] = {["a"] = "", ["Ä"] = "à·", ["i"] = "à·’", ["Ä«"] = "à·“", ["u"] = "à·”", ["Å«"] = "à·–", ["e"] = "à·™", ["o"] = "à·œ", [""] = ""},

    ["Thai"] = {["a"] = "", ["Ä"] = "à¸²", ["i"] = "à¸´", ["Ä«"] = "à¸µ", ["u"] = "à¸¸", ["Å«"] = "à¸¹", ["e"] = "à¹€", ["o"] = "à¹‚", [""] = ""},

    ["Lana"] = {["a"] = "", ["Ä"] = "á©£", ["i"] = "á©¥", ["Ä«"] = "á©¦", ["u"] = "á©©", ["Å«"] = "á©ª", ["e"] = "á©®", ["o"] = "á©®á©£", [""] = ""},

    ["Laoo"] = {["a"] = "", ["Ä"] = "àº²", ["i"] = "àº´", ["Ä«"] = "àºµ", ["u"] = "àº¸", ["Å«"] = "àº¹", ["e"] = "à»€", ["o"] = "à»‚", [""] = ""}
}

local s = {
    ["Deva"] = {["0"] = "à¥¦", ["1"] = "à¥§", ["2"] = "à¥¨", ["3"] = "à¥©", ["4"] = "à¥ª", ["5"] = "à¥«", ["6"] = "à¥¬", ["7"] = "à¥­", ["8"] = "à¥®", ["9"] = "à¥¯", ["."] = "à¥¥", [","] = "à¥¤", ["-"] = "-"},

    ["Beng"] = {["0"] = "à§¦", ["1"] = "à§§", ["2"] = "à§¨", ["3"] = "à§©", ["4"] = "à§ª", ["5"] = "à§«", ["6"] = "à§¬", ["7"] = "à§­", ["8"] = "à§®", ["9"] = "à§¯", ["."] = ".", [","] = ",", ["-"] = "-"},

    ["Brah"] = {["0"] = "ğ‘¦", ["1"] = "ğ‘§", ["2"] = "ğ‘¨", ["3"] = "ğ‘©", ["4"] = "ğ‘ª", ["5"] = "ğ‘«", ["6"] = "ğ‘¬", ["7"] = "ğ‘­", ["8"] = "ğ‘®", ["9"] = "ğ‘¯", ["."] = "ğ‘ˆ", [","] = "ğ‘‡", ["-"] = "-"},

    ["Khmr"] = {["0"] = "áŸ ", ["1"] = "áŸ¡", ["2"] = "áŸ¢", ["3"] = "áŸ£", ["4"] = "áŸ¤", ["5"] = "áŸ¥", ["6"] = "áŸ¦", ["7"] = "áŸ§", ["8"] = "áŸ¨", ["9"] = "áŸ©", ["."] = "áŸ•", [","] = "áŸ”", ["-"] = "-"},

    ["Mymr"] = {["0"] = "á€", ["1"] = "á", ["2"] = "á‚", ["3"] = "áƒ", ["4"] = "á„", ["5"] = "á…", ["6"] = "á†", ["7"] = "á‡", ["8"] = "áˆ", ["9"] = "á‰", ["."] = "á‹", [","] = "áŠ", ["-"] = "-"},

    ["Sinh"] = {["0"] = "0", ["1"] = "1", ["2"] = "2", ["3"] = "3", ["4"] = "4", ["5"] = "5", ["6"] = "6", ["7"] = "7", ["8"] = "8", ["9"] = "9", ["."] = ".", [","] = ",", ["-"] = "-"},

    ["Thai"] = {["0"] = "à¹", ["1"] = "à¹‘", ["2"] = "à¹’", ["3"] = "à¹“", ["4"] = "à¹”", ["5"] = "à¹•", ["6"] = "à¹–", ["7"] = "à¹—", ["8"] = "à¹˜", ["9"] = "à¹™", ["."] = "à¹š", [","] = "à¸¯", ["-"] = "-"},

    ["Lana"] = {["0"] = "áª", ["1"] = "áª‘", ["2"] = "áª’", ["3"] = "áª“", ["4"] = "áª”", ["5"] = "áª•", ["6"] = "áª–", ["7"] = "áª—", ["8"] = "áª˜", ["9"] = "áª™", ["."] = "áª©", [","] = "áª¨", ["-"] = "-"},

    ["Laoo"] = {["0"] = "à»", ["1"] = "à»‘", ["2"] = "à»’", ["3"] = "à»“", ["4"] = "à»”", ["5"] = "à»•", ["6"] = "à»–", ["7"] = "à»—", ["8"] = "à»˜", ["9"] = "à»™", ["."] = "àº¯àº¯", [","] = "àº¯", ["-"] = "-"}
}

local join = {["Deva"] = "à¥", ["Beng"] = "à§", ["Brah"] = "ğ‘†", ["Khmr"] = "áŸ’", ["Mymr"] = "á€¹", ["Sinh"] = u(0x200d, 0x0dca), ["Thai"] = "à¸º", ["Lana"] = "á© ", ["Laoo"] = "àºº"}

local kill = {["Deva"] = "à¥", ["Beng"] = "à§", ["Brah"] = "ğ‘†", ["Khmr"] = "áŸ‘", ["Mymr"] = "á€º", ["Sinh"] = "à·Š", ["Thai"] = "à¸º", ["Lana"] = "á©º", ["Laoo"] = "àºº"}

local sinh_cjct = {["à¶šâ€à·Šà·€"] = "à¶šà·Šâ€à·€", ["à¶­â€à·Šà¶®"] = "à¶­à·Šâ€à¶®", ["à¶­â€à·Šà·€"] = "à¶­à·Šâ€à·€", ["à¶±â€à·Šà¶®"] = "à¶±à·Šâ€à¶®", ["à¶±â€à·Šà¶¯"] = "à¶±à·Šâ€à¶¯", ["à¶±â€à·Šà¶°"] = "à¶±à·Šâ€à¶°", ["à¶±â€à·Šà·€"] = "à¶±à·Šâ€à·€"}

local nukta = u(0x09bc) -- Just list all those used here.

local variations = {
    ["Mon"] = {
        ["á€ˆ"] = "á›",
        ["á€¤"] = "á€£á€³",
        ["á€¦"] = "á€¥á€¯",
        ["á€§"] = "á€¨",
        ["á€®"] = "á€³" -- for IM fix below
        -- Unicode doesn't have "great nya" so just leave á€Šá€¹á€Š as is. (It looks like á€Š with one extra curve.)
    },
    ["OldShan"] = {
        ["á€€"] = "áµ",
        ["á€"] = "á¶",
        ["á€‚"] = "á·",
        ["á€ƒ"] = "ê§ ",
        ["á€…"] = "á¸",
        ["á€†"] = "ê§¡",
        ["á€‡"] = "á¹",
        ["á€ˆ"] = "ê§¢",
        ["á€‰"] = "áº",
        ["á€Š"] = "áºá€¹áº",
        ["á€‹"] = "ê©¦",
        ["á€Œ"] = "ê©§",
        ["á€"] = "ê©¨",
        ["á€"] = "ê©©",
        ["á€"] = "ê§£",
        ["á€’"] = "á»",
        ["á€“"] = "ê©ª",
        ["á€”"] = "á¼",
        ["á€–"] = "á½",
        ["á€—"] = "á¿",
        ["á€˜"] = "ê§¤",
        ["á€Ÿ"] = "á‚",
        ["á€ "] = "ê©®",
        ["á€¡"] = "á€¢",
        ["á€£"] = "á€¢á€­",
        ["á€¤"] = "á€¢á€®",
        ["á€¥"] = "á€¢á€¯",
        ["á€¦"] = "á€¢á€°",
        ["á€§"] = "á€¢á€±",
        ["á€©"] = "á€¢á€±á‚ƒ",
        ["á€«"] = "á‚ƒ",
        ["á€¬"] = "á‚ƒ"
        -- Unicode doesn't have "Shan great sa" so just leave á€¿ as is.
    },
    ["NewShan"] = {
        -- includes all Old Shan and the followings
        ["á€¿"] = "á€á€ºá€",
        ["á€¹"] = "á€º"
    }
}

-- Unnatural sequences of combining marks are frequently unreadable.  Therefore, they are displayed on
-- bearers so that the code can be understood and, if necessary, corrected.
local dc = function(text) return gsub(text, "[à¸­àº­]", "") end -- Discard bearer

local transform
function export.mono_form(text, script)

    local result = text

    if script == "Thai" then
        result = gsub(result, "à¹", "à¸‡à¸º")
        result = gsub(result, "([à¸-à¸®])à¸º", "à¸±%1à¸º")
        result = gsub(result, "([à¸-à¸®])([^à¸°à¸±à¸²à¸´à¸µà¸ºà¸¸à¸¹])", "%1à¸°%2")
        result = gsub(result, "([à¸-à¸®])([^à¸°à¸±à¸²à¸´à¸µà¸ºà¸¸à¸¹])", "%1à¸°%2") -- twice
        result = gsub(result, "([à¸-à¸®])$", "%1à¸°")
        --		result = gsub(result, "([à¸-à¸®])([à¸²à¸´à¸µà¸¸à¸¹])à¸±", "%1%2")
        result = gsub(result, dc("([à¸-à¸®])([à¸²à¸­à¸´à¸­à¸µà¸­à¸ºà¸­à¸¸à¸­à¸¹])à¸­à¸±"), "%1%2")
        result = gsub(result, "([à¹€à¹‚])([à¸-à¸®])([à¸°à¸±])", "%1%2")
        result = gsub(result, "^à¸±", "")
        result = gsub(result, "([%s%p])à¸±", "%1")
        result = gsub(result, "à¸º", "")
    elseif script == "Laoo" then
        -- Calculating transform in argument list of gsub() fails!
        if not transform then
            transform = {
                {dc("àº­à»"), dc("àº‡àº­àºº")}, {dc("([àº-àº®])àº­àºº"), dc("àº­àº±%1àº­àºº")}, {dc("([àº-àº®])([^àº°àº­àº±àº²àº­àº´àº­àºµàº­àººàº­àº¸àº­àº¹])"), "%1àº°%2"}, {dc("([àº-àº®])([^àº°àº­àº±àº²àº­àº´àº­àºµàº­àººàº­àº¸àº­àº¹])"), "%1àº°%2"}, -- twice!
                {"([àº-àº®])$", "%1àº°"}, {dc("([àº-àº®])([àº²àº­àº´àº­àºµàº­àººàº­àº¸àº­àº¹])àº­àº±"), "%1%2"}, {dc("([à»€à»‚])([àº-àº®])([àº°àº­àº±])"), "%1%2"}, {dc("^àº­àº±"), ""}, {dc("([%s%p])àº­àº±"), "%1"}, {dc("àº­àºº"), ""}
            }
        end
        for _, v in ipairs(transform) do result = gsub(result, v[1], v[2]) end
    end

    return result
end

local function return_error(text) return error(("Unrecognised part: \"%s\""):format(text)) end

function export.tr(text, script, options)
    if type(text) == "table" then
        options = {}
        options.impl = text.args["impl"]
        options.variation = text.args["variation"] -- ID of variation: [Mymr: 1=Mon, 2=Old Shan, 3=New Shan]
        text, script = text.args[1], text.args[2]
    end
    if script == "Latn" then return text end
    if not s[script] then return nil end

    text = mw.ustring.lower(text)
    text = gsub(text, "[0-9%.,%-]", s[script])
    -- Compose patterns for processing onsets. 
    local letter = "[^" .. join[script] .. nukta .. "][" .. nukta .. "]?"
    local letter_pair = "(" .. letter .. ")(" .. letter .. ")"

    for word in mw.ustring.gmatch(text, "[aÄiÄ«uÅ«eoá¹ƒkhgá¹…cjÃ±á¹­á¸á¹‡tdnpbmyrlá¸·vs]+") do
        local word_conv, orig_word = {}, word
        word = gsub(word, "([aÄiÄ«uÅ«eo]á¹ƒ?)", "%1 ")
        word = gsub(word, " $", "")

        for syllable in mw.text.gsplit(word, " ") do
            if not match(syllable, "[aÄiÄ«uÅ«eoá¹ƒ]$") then syllable = syllable .. "a" .. kill[script] end
            syllable = gsub(syllable, "^([khgá¹…cjÃ±á¹­á¸á¹‡tdnpbmyrlá¸·vs]*)([aÄiÄ«uÅ«eo])(á¹ƒ?)([à¥à§áŸ‘á€ºà·Šà¸ºğ‘†á©ºàºº]?)$", function(onset, vowel, coda, optJoin)
                if onset == "" then
                    onset = vowel
                    vowel = ""
                end
                if not c[script][onset] then
                    onset = gsub(onset, ".h", c[script])
                    onset = gsub(onset, ".", c[script])
                    -- Join pairs of consonants
                    onset = gsub(onset, letter_pair, "%1" .. join[script] .. "%2")
                    -- Join adjacent consonants that were in different pairs.
                    onset = gsub(onset, letter_pair, "%1" .. join[script] .. "%2")
                else
                    onset = c[script][onset]
                end

                return onset .. (v[script][vowel] or return_error(vowel)) .. c[script][coda] .. optJoin
            end)

            table.insert(word_conv, syllable)
        end
        word = table.concat(word_conv, "")
        if script == "Thai" then
            word = gsub(word, "(.)([à¹€à¹‚])", "%2%1")
        elseif script == "Mymr" then
            word = gsub(word, "á€„á€¹", "á€„á€ºá€¹")
            word = gsub(word, "(á€„á€ºá€¹)([á€á€‚á€„á€’á€•á€])(á€±?)á€¬", "%1%2%3á€«")
            word = gsub(word, "á€¹[á€šá€›]", {["á€¹á€š"] = "á€»", ["á€¹á€›"] = "á€¼"}) -- these not need tall aa
            word = gsub(word, "^([á€á€‚á€„á€’á€•á€])(á€±?)á€¬", "%1%2á€«")
            word = gsub(word, "([^á€¹])([á€á€‚á€„á€’á€•á€])(á€±?)á€¬", "%1%2%3á€«")
            word = gsub(word, "([á€á€‚á€„á€’á€•á€])(á€¹[á€€-á€¡á€¿])(á€±?)á€¬", "%1%2%3á€«")
            word = gsub(word, "á€¹[á€á€Ÿ]", {["á€¹á€"] = "á€½", ["á€¹á€Ÿ"] = "á€¾"})
            word = gsub(word, "á€‰á€¹á€‰", "á€Š")
            word = gsub(word, "á€á€¹á€", "á€¿")
            if not (options and options.variation) then
                -- Arg options should be optional, so nothing to do. 
            elseif options.variation == "1" then
                word = gsub(word, ".", variations.Mon)
                word = gsub(word, "á€­á€¶", "á€®") -- fix IM
            elseif options.variation == "2" then
                word = gsub(word, ".", variations.OldShan)
            elseif options.variation == "3" then
                word = gsub(word, ".", variations.OldShan)
                word = gsub(word, ".", variations.NewShan)
                word = gsub(word, "á€º" .. "á€º", "á€º") -- fix nga
            end
        elseif script == "Lana" then
            word = gsub(word, "á¨¦á© ", "á©˜")
            word = gsub(word, "^([á¨£á¨´á¨µá¨·á©…])(á©®?)á©£", "%1%2á©¤")
            word = gsub(word, "([^á© ])([á¨£á¨´á¨µá¨·á©…])(á©®?)á©£", "%1%2%3á©¤")
            word = gsub(word, "([á¨£á¨´á¨µá¨·á©…])(á© [á¨ -á©Œá©”])(á©®?)á©£", "%1%2%3á©¤")
            word = gsub(word, "á© [á©á©ƒ]", {["á© á©"] = "á©•", ["á© á©ƒ"] = "á©–"})
            word = gsub(word, "([á¨­-á¨±])á© á¨®", "%1á©›")
            word = gsub(word, "([á¨·-á¨¾])á© á¨»", "%1á©›")
            word = gsub(word, "á©ˆá© á©ˆ", "á©”")
        elseif script == "Beng" then
            word = gsub(word, "à§°à§", "à§°" .. u(0x200d) .. "à§") -- à§°à§(v-) needs ZWJ to display correctly
        elseif script == "Sinh" then
            local js = join["Sinh"]
            word = gsub(word, "(" .. js .. ")([à¶ºà¶»])", u(0xdca, 0x200d) .. "%2")
            word = gsub(word, "[à¶šà¶­à¶±]" .. js .. "[à¶®à¶¯à¶°à·€]", sinh_cjct)
        elseif script == "Laoo" then
            word = gsub(word, "(.)([à»€à»‚])", "%2%1")
        end
        text = gsub(text, orig_word, word, 1)
    end
    local impl = options and options.impl or "yes"
    if impl == "no" then text = export.mono_form(text, script) end
    return text
end

return export
