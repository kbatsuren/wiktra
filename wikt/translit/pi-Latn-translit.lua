-- For Lao script, see https://www.unicode.org/charts/PDF/U0E80.pdf (Unicode 12.0+)
local export = {}
local gsub = mw.ustring.gsub
local match = mw.ustring.match
local sub = mw.ustring.sub
local u = mw.ustring.char

local c = {
    ["Deva"] = {["k"] = "рдХ", ["kh"] = "рдЦ", ["g"] = "рдЧ", ["gh"] = "рдШ", ["с╣Е"] = "рдЩ", ["c"] = "рдЪ", ["ch"] = "рдЫ", ["j"] = "рдЬ", ["jh"] = "рдЭ", ["├▒"] = "рдЮ", ["с╣н"] = "рдЯ", ["с╣нh"] = "рда", ["с╕Н"] = "рдб", ["с╕Нh"] = "рдв", ["с╣З"] = "рдг", ["t"] = "рдд", ["th"] = "рде", ["d"] = "рдж", ["dh"] = "рдз", ["n"] = "рди", ["p"] = "рдк", ["ph"] = "рдл", ["b"] = "рдм", ["bh"] = "рдн", ["m"] = "рдо", ["y"] = "рдп", ["r"] = "рд░", ["l"] = "рд▓", ["v"] = "рд╡", ["s"] = "рд╕", ["h"] = "рд╣", ["с╕╖"] = "рд│", ["a"] = "рдЕ", ["─Б"] = "рдЖ", ["i"] = "рдЗ", ["─л"] = "рдИ", ["u"] = "рдЙ", ["┼л"] = "рдК", ["e"] = "рдП", ["o"] = "рдУ", ["с╣Г"] = "рдВ", [""] = ""},

    ["Beng"] = {["k"] = "ржХ", ["kh"] = "ржЦ", ["g"] = "ржЧ", ["gh"] = "ржШ", ["с╣Е"] = "ржЩ", ["c"] = "ржЪ", ["ch"] = "ржЫ", ["j"] = "ржЬ", ["jh"] = "ржЭ", ["├▒"] = "ржЮ", ["с╣н"] = "ржЯ", ["с╣нh"] = "ржа", ["с╕Н"] = "ржб", ["с╕Нh"] = "ржв", ["с╣З"] = "ржг", ["t"] = "ржд", ["th"] = "рже", ["d"] = "ржж", ["dh"] = "ржз", ["n"] = "ржи", ["p"] = "ржк", ["ph"] = "ржл", ["b"] = "ржм", ["bh"] = "ржн", ["m"] = "ржо", ["y"] = "ржп", ["r"] = "рж░", ["l"] = "рж▓", ["v"] = "рз░", ["s"] = "рж╕", ["h"] = "рж╣", ["с╕╖"] = "рж▓рж╝", ["a"] = "ржЕ", ["─Б"] = "ржЖ", ["i"] = "ржЗ", ["─л"] = "ржИ", ["u"] = "ржЙ", ["┼л"] = "ржК", ["e"] = "ржП", ["o"] = "ржУ", ["с╣Г"] = "ржВ", [""] = ""},

    ["Brah"] = {["k"] = "ЁСАУ", ["kh"] = "ЁСАФ", ["g"] = "ЁСАХ", ["gh"] = "ЁСАЦ", ["с╣Е"] = "ЁСАЧ", ["c"] = "ЁСАШ", ["ch"] = "ЁСАЩ", ["j"] = "ЁСАЪ", ["jh"] = "ЁСАЫ", ["├▒"] = "ЁСАЬ", ["с╣н"] = "ЁСАЭ", ["с╣нh"] = "ЁСАЮ", ["с╕Н"] = "ЁСАЯ", ["с╕Нh"] = "ЁСАа", ["с╣З"] = "ЁСАб", ["t"] = "ЁСАв", ["th"] = "ЁСАг", ["d"] = "ЁСАд", ["dh"] = "ЁСАе", ["n"] = "ЁСАж", ["p"] = "ЁСАз", ["ph"] = "ЁСАи", ["b"] = "ЁСАй", ["bh"] = "ЁСАк", ["m"] = "ЁСАл", ["y"] = "ЁСАм", ["r"] = "ЁСАн", ["l"] = "ЁСАо", ["v"] = "ЁСАп", ["s"] = "ЁСА▓", ["h"] = "ЁСА│", ["с╕╖"] = "ЁСА┤", ["a"] = "ЁСАЕ", ["─Б"] = "ЁСАЖ", ["i"] = "ЁСАЗ", ["─л"] = "ЁСАИ", ["u"] = "ЁСАЙ", ["┼л"] = "ЁСАК", ["e"] = "ЁСАП", ["o"] = "ЁСАС", ["с╣Г"] = "ЁСАБ", [""] = ""},

    ["Khmr"] = {["k"] = "сЮА", ["kh"] = "сЮБ", ["g"] = "сЮВ", ["gh"] = "сЮГ", ["с╣Е"] = "сЮД", ["c"] = "сЮЕ", ["ch"] = "сЮЖ", ["j"] = "сЮЗ", ["jh"] = "сЮИ", ["├▒"] = "сЮЙ", ["с╣н"] = "сЮК", ["с╣нh"] = "сЮЛ", ["с╕Н"] = "сЮМ", ["с╕Нh"] = "сЮН", ["с╣З"] = "сЮО", ["t"] = "сЮП", ["th"] = "сЮР", ["d"] = "сЮС", ["dh"] = "сЮТ", ["n"] = "сЮУ", ["p"] = "сЮФ", ["ph"] = "сЮХ", ["b"] = "сЮЦ", ["bh"] = "сЮЧ", ["m"] = "сЮШ", ["y"] = "сЮЩ", ["r"] = "сЮЪ", ["l"] = "сЮЫ", ["v"] = "сЮЬ", ["s"] = "сЮЯ", ["h"] = "сЮа", ["с╕╖"] = "сЮб", ["a"] = "сЮв", ["─Б"] = "сЮвсЮ╢", ["i"] = "сЮе", ["─л"] = "сЮж", ["u"] = "сЮз", ["┼л"] = "сЮи", ["e"] = "сЮп", ["o"] = "сЮ▓", ["с╣Г"] = "сЯЖ", [""] = ""},

    ["Mymr"] = {["k"] = "сАА", ["kh"] = "сАБ", ["g"] = "сАВ", ["gh"] = "сАГ", ["с╣Е"] = "сАД", ["c"] = "сАЕ", ["ch"] = "сАЖ", ["j"] = "сАЗ", ["jh"] = "сАИ", ["├▒"] = "сАЙ", ["с╣н"] = "сАЛ", ["с╣нh"] = "сАМ", ["с╕Н"] = "сАН", ["с╕Нh"] = "сАО", ["с╣З"] = "сАП", ["t"] = "сАР", ["th"] = "сАС", ["d"] = "сАТ", ["dh"] = "сАУ", ["n"] = "сАФ", ["p"] = "сАХ", ["ph"] = "сАЦ", ["b"] = "сАЧ", ["bh"] = "сАШ", ["m"] = "сАЩ", ["y"] = "сАЪ", ["r"] = "сАЫ", ["l"] = "сАЬ", ["v"] = "сАЭ", ["s"] = "сАЮ", ["h"] = "сАЯ", ["с╕╖"] = "сАа", ["a"] = "сАб", ["─Б"] = "сАбсАм", ["i"] = "сАг", ["─л"] = "сАд", ["u"] = "сАе", ["┼л"] = "сАж", ["e"] = "сАз", ["o"] = "сАй", ["с╣Г"] = "сА╢", [""] = ""},

    ["Sinh"] = {["k"] = "р╢Ъ", ["kh"] = "р╢Ы", ["g"] = "р╢Ь", ["gh"] = "р╢Э", ["с╣Е"] = "р╢Ю", ["c"] = "р╢а", ["ch"] = "р╢б", ["j"] = "р╢в", ["jh"] = "р╢г", ["├▒"] = "р╢д", ["с╣н"] = "р╢з", ["с╣нh"] = "р╢и", ["с╕Н"] = "р╢й", ["с╕Нh"] = "р╢к", ["с╣З"] = "р╢л", ["t"] = "р╢н", ["th"] = "р╢о", ["d"] = "р╢п", ["dh"] = "р╢░", ["n"] = "р╢▒", ["p"] = "р╢┤", ["ph"] = "р╢╡", ["b"] = "р╢╢", ["bh"] = "р╢╖", ["m"] = "р╢╕", ["y"] = "р╢║", ["r"] = "р╢╗", ["l"] = "р╢╜", ["v"] = "р╖А", ["s"] = "р╖Г", ["h"] = "р╖Д", ["с╕╖"] = "р╖Е", ["a"] = "р╢Е", ["─Б"] = "р╢Ж", ["i"] = "р╢Й", ["─л"] = "р╢К", ["u"] = "р╢Л", ["┼л"] = "р╢М", ["e"] = "р╢С", ["o"] = "р╢Ф", ["с╣Г"] = "р╢В", [""] = ""},

    ["Thai"] = {
        ["k"] = "р╕Б",
        ["kh"] = "р╕В",
        ["g"] = "р╕Д",
        ["gh"] = "р╕Ж",
        ["с╣Е"] = "р╕З",
        ["c"] = "р╕И",
        ["ch"] = "р╕Й",
        ["j"] = "р╕К",
        ["jh"] = "р╕М",
        ["├▒"] = "р╕Н",
        ["с╣н"] = "р╕П",
        ["с╣нh"] = "р╕Р",
        ["с╕Н"] = "р╕С",
        ["с╕Нh"] = "р╕Т",
        ["с╣З"] = "р╕У",
        ["t"] = "р╕Х",
        ["th"] = "р╕Ц",
        ["d"] = "р╕Ч",
        ["dh"] = "р╕Ш",
        ["n"] = "р╕Щ",
        ["p"] = "р╕Ы",
        ["ph"] = "р╕Ь",
        ["b"] = "р╕Ю",
        ["bh"] = "р╕а",
        ["m"] = "р╕б",
        ["y"] = "р╕в",
        ["r"] = "р╕г",
        ["l"] = "р╕е",
        ["v"] = "р╕з",
        ["s"] = "р╕к",
        ["h"] = "р╕л",
        ["с╕╖"] = "р╕м",

        ["a"] = "р╕н",
        ["─Б"] = "р╕нр╕▓",
        ["i"] = "р╕нр╕┤",
        ["─л"] = "р╕нр╕╡",
        ["u"] = "р╕нр╕╕",
        ["┼л"] = "р╕нр╕╣",
        ["e"] = "р╕нр╣А", -- to be swapped later
        ["o"] = "р╕нр╣В", -- to be swapped later

        ["с╣Г"] = "р╣Н",
        [""] = ""
    },

    ["Lana"] = {["k"] = "сиа", ["kh"] = "сиб", ["g"] = "сиг", ["gh"] = "сие", ["с╣Е"] = "сиж", ["c"] = "сиз", ["ch"] = "сии", ["j"] = "сий", ["jh"] = "сил", ["├▒"] = "сим", ["с╣н"] = "син", ["с╣нh"] = "сио", ["с╕Н"] = "сип", ["с╕Нh"] = "си░", ["с╣З"] = "си▒", ["t"] = "си▓", ["th"] = "си│", ["d"] = "си┤", ["dh"] = "си╡", ["n"] = "си╢", ["p"] = "си╖", ["ph"] = "си╣", ["b"] = "си╗", ["bh"] = "си╜", ["m"] = "си╛", ["y"] = "си┐", ["r"] = "сйБ", ["l"] = "сйГ", ["v"] = "сйЕ", ["s"] = "сйИ", ["h"] = "сйЙ", ["с╕╖"] = "сйК", ["a"] = "сйЛ", ["─Б"] = "сйЛсйг", ["i"] = "сйН", ["─л"] = "сйО", ["u"] = "сйП", ["┼л"] = "сйР", ["e"] = "сйС", ["o"] = "сйЛсй░", ["с╣Г"] = "сй┤", [""] = ""},

    ["Laoo"] = {
        ["k"] = "р║Б",
        ["kh"] = "р║В",
        ["g"] = "р║Д",
        ["gh"] = "р║Ж",
        ["с╣Е"] = "р║З",
        ["c"] = "р║И",
        ["ch"] = "р║Й",
        ["j"] = "р║К",
        ["jh"] = "р║М",
        ["├▒"] = "р║О",
        ["с╣н"] = "р║П",
        ["с╣нh"] = "р║Р",
        ["с╕Н"] = "р║С",
        ["с╕Нh"] = "р║Т",
        ["с╣З"] = "р║У",
        ["t"] = "р║Х",
        ["th"] = "р║Ц",
        ["d"] = "р║Ч",
        ["dh"] = "р║Ш",
        ["n"] = "р║Щ",
        ["p"] = "р║Ы",
        ["ph"] = "р║Ь",
        ["b"] = "р║Ю",
        ["bh"] = "р║а",
        ["m"] = "р║б",
        ["y"] = "р║Н",
        ["r"] = "р║г",
        ["l"] = "р║е",
        ["v"] = "р║з",
        ["s"] = "р║к",
        ["h"] = "р║л",
        ["с╕╖"] = "р║м",

        ["a"] = "р║н",
        ["─Б"] = "р║нр║▓",
        ["i"] = "р║нр║┤",
        ["─л"] = "р║нр║╡",
        ["u"] = "р║нр║╕",
        ["┼л"] = "р║нр║╣",
        ["e"] = "р║нр╗А", -- to be swapped later
        ["o"] = "р║нр╗В", -- to be swapped later

        ["с╣Г"] = "р╗Н",
        [""] = ""
    }

}

local v = {
    ["Deva"] = {["a"] = "", ["─Б"] = "рд╛", ["i"] = "рд┐", ["─л"] = "реА", ["u"] = "реБ", ["┼л"] = "реВ", ["e"] = "реЗ", ["o"] = "реЛ", [""] = ""},

    ["Beng"] = {["a"] = "", ["─Б"] = "рж╛", ["i"] = "рж┐", ["─л"] = "рзА", ["u"] = "рзБ", ["┼л"] = "рзВ", ["e"] = "рзЗ", ["o"] = "рзЛ", [""] = ""},

    ["Brah"] = {["a"] = "", ["─Б"] = "ЁСА╕", ["i"] = "ЁСА║", ["─л"] = "ЁСА╗", ["u"] = "ЁСА╝", ["┼л"] = "ЁСА╜", ["e"] = "ЁСБВ", ["o"] = "ЁСБД", [""] = ""},

    ["Khmr"] = {["a"] = "", ["─Б"] = "сЮ╢", ["i"] = "сЮ╖", ["─л"] = "сЮ╕", ["u"] = "сЮ╗", ["┼л"] = "сЮ╝", ["e"] = "сЯБ", ["o"] = "сЯД", [""] = ""},

    ["Mymr"] = {["a"] = "", ["─Б"] = "сАм", ["i"] = "сАн", ["─л"] = "сАо", ["u"] = "сАп", ["┼л"] = "сА░", ["e"] = "сА▒", ["o"] = "сА▒сАм", [""] = ""},

    ["Sinh"] = {["a"] = "", ["─Б"] = "р╖П", ["i"] = "р╖Т", ["─л"] = "р╖У", ["u"] = "р╖Ф", ["┼л"] = "р╖Ц", ["e"] = "р╖Щ", ["o"] = "р╖Ь", [""] = ""},

    ["Thai"] = {["a"] = "", ["─Б"] = "р╕▓", ["i"] = "р╕┤", ["─л"] = "р╕╡", ["u"] = "р╕╕", ["┼л"] = "р╕╣", ["e"] = "р╣А", ["o"] = "р╣В", [""] = ""},

    ["Lana"] = {["a"] = "", ["─Б"] = "сйг", ["i"] = "сйе", ["─л"] = "сйж", ["u"] = "сйй", ["┼л"] = "сйк", ["e"] = "сйо", ["o"] = "сйосйг", [""] = ""},

    ["Laoo"] = {["a"] = "", ["─Б"] = "р║▓", ["i"] = "р║┤", ["─л"] = "р║╡", ["u"] = "р║╕", ["┼л"] = "р║╣", ["e"] = "р╗А", ["o"] = "р╗В", [""] = ""}
}

local s = {
    ["Deva"] = {["0"] = "реж", ["1"] = "рез", ["2"] = "реи", ["3"] = "рей", ["4"] = "рек", ["5"] = "рел", ["6"] = "рем", ["7"] = "рен", ["8"] = "рео", ["9"] = "реп", ["."] = "рее", [","] = "ред", ["-"] = "-"},

    ["Beng"] = {["0"] = "рзж", ["1"] = "рзз", ["2"] = "рзи", ["3"] = "рзй", ["4"] = "рзк", ["5"] = "рзл", ["6"] = "рзм", ["7"] = "рзн", ["8"] = "рзо", ["9"] = "рзп", ["."] = ".", [","] = ",", ["-"] = "-"},

    ["Brah"] = {["0"] = "ЁСБж", ["1"] = "ЁСБз", ["2"] = "ЁСБи", ["3"] = "ЁСБй", ["4"] = "ЁСБк", ["5"] = "ЁСБл", ["6"] = "ЁСБм", ["7"] = "ЁСБн", ["8"] = "ЁСБо", ["9"] = "ЁСБп", ["."] = "ЁСБИ", [","] = "ЁСБЗ", ["-"] = "-"},

    ["Khmr"] = {["0"] = "сЯа", ["1"] = "сЯб", ["2"] = "сЯв", ["3"] = "сЯг", ["4"] = "сЯд", ["5"] = "сЯе", ["6"] = "сЯж", ["7"] = "сЯз", ["8"] = "сЯи", ["9"] = "сЯй", ["."] = "сЯХ", [","] = "сЯФ", ["-"] = "-"},

    ["Mymr"] = {["0"] = "сБА", ["1"] = "сББ", ["2"] = "сБВ", ["3"] = "сБГ", ["4"] = "сБД", ["5"] = "сБЕ", ["6"] = "сБЖ", ["7"] = "сБЗ", ["8"] = "сБИ", ["9"] = "сБЙ", ["."] = "сБЛ", [","] = "сБК", ["-"] = "-"},

    ["Sinh"] = {["0"] = "0", ["1"] = "1", ["2"] = "2", ["3"] = "3", ["4"] = "4", ["5"] = "5", ["6"] = "6", ["7"] = "7", ["8"] = "8", ["9"] = "9", ["."] = ".", [","] = ",", ["-"] = "-"},

    ["Thai"] = {["0"] = "р╣Р", ["1"] = "р╣С", ["2"] = "р╣Т", ["3"] = "р╣У", ["4"] = "р╣Ф", ["5"] = "р╣Х", ["6"] = "р╣Ц", ["7"] = "р╣Ч", ["8"] = "р╣Ш", ["9"] = "р╣Щ", ["."] = "р╣Ъ", [","] = "р╕п", ["-"] = "-"},

    ["Lana"] = {["0"] = "скР", ["1"] = "скС", ["2"] = "скТ", ["3"] = "скУ", ["4"] = "скФ", ["5"] = "скХ", ["6"] = "скЦ", ["7"] = "скЧ", ["8"] = "скШ", ["9"] = "скЩ", ["."] = "скй", [","] = "ски", ["-"] = "-"},

    ["Laoo"] = {["0"] = "р╗Р", ["1"] = "р╗С", ["2"] = "р╗Т", ["3"] = "р╗У", ["4"] = "р╗Ф", ["5"] = "р╗Х", ["6"] = "р╗Ц", ["7"] = "р╗Ч", ["8"] = "р╗Ш", ["9"] = "р╗Щ", ["."] = "р║пр║п", [","] = "р║п", ["-"] = "-"}
}

local join = {["Deva"] = "реН", ["Beng"] = "рзН", ["Brah"] = "ЁСБЖ", ["Khmr"] = "сЯТ", ["Mymr"] = "сА╣", ["Sinh"] = u(0x200d, 0x0dca), ["Thai"] = "р╕║", ["Lana"] = "сйа", ["Laoo"] = "р║║"}

local kill = {["Deva"] = "реН", ["Beng"] = "рзН", ["Brah"] = "ЁСБЖ", ["Khmr"] = "сЯС", ["Mymr"] = "сА║", ["Sinh"] = "р╖К", ["Thai"] = "р╕║", ["Lana"] = "сй║", ["Laoo"] = "р║║"}

local sinh_cjct = {["р╢ЪтАНр╖Кр╖А"] = "р╢Ър╖КтАНр╖А", ["р╢нтАНр╖Кр╢о"] = "р╢нр╖КтАНр╢о", ["р╢нтАНр╖Кр╖А"] = "р╢нр╖КтАНр╖А", ["р╢▒тАНр╖Кр╢о"] = "р╢▒р╖КтАНр╢о", ["р╢▒тАНр╖Кр╢п"] = "р╢▒р╖КтАНр╢п", ["р╢▒тАНр╖Кр╢░"] = "р╢▒р╖КтАНр╢░", ["р╢▒тАНр╖Кр╖А"] = "р╢▒р╖КтАНр╖А"}

local nukta = u(0x09bc) -- Just list all those used here.

local variations = {
    ["Mon"] = {
        ["сАИ"] = "сБЫ",
        ["сАд"] = "сАгсА│",
        ["сАж"] = "сАесАп",
        ["сАз"] = "сАи",
        ["сАо"] = "сА│" -- for IM fix below
        -- Unicode doesn't have "great nya" so just leave сАКсА╣сАК as is. (It looks like сАК with one extra curve.)
    },
    ["OldShan"] = {
        ["сАА"] = "сБ╡",
        ["сАБ"] = "сБ╢",
        ["сАВ"] = "сБ╖",
        ["сАГ"] = "ъза",
        ["сАЕ"] = "сБ╕",
        ["сАЖ"] = "ъзб",
        ["сАЗ"] = "сБ╣",
        ["сАИ"] = "ъзв",
        ["сАЙ"] = "сБ║",
        ["сАК"] = "сБ║сА╣сБ║",
        ["сАЛ"] = "ъйж",
        ["сАМ"] = "ъйз",
        ["сАН"] = "ъйи",
        ["сАО"] = "ъйй",
        ["сАП"] = "ъзг",
        ["сАТ"] = "сБ╗",
        ["сАУ"] = "ъйк",
        ["сАФ"] = "сБ╝",
        ["сАЦ"] = "сБ╜",
        ["сАЧ"] = "сБ┐",
        ["сАШ"] = "ъзд",
        ["сАЯ"] = "сВБ",
        ["сАа"] = "ъйо",
        ["сАб"] = "сАв",
        ["сАг"] = "сАвсАн",
        ["сАд"] = "сАвсАо",
        ["сАе"] = "сАвсАп",
        ["сАж"] = "сАвсА░",
        ["сАз"] = "сАвсА▒",
        ["сАй"] = "сАвсА▒сВГ",
        ["сАл"] = "сВГ",
        ["сАм"] = "сВГ"
        -- Unicode doesn't have "Shan great sa" so just leave сА┐ as is.
    },
    ["NewShan"] = {
        -- includes all Old Shan and the followings
        ["сА┐"] = "сАЮсА║сАЮ",
        ["сА╣"] = "сА║"
    }
}

-- Unnatural sequences of combining marks are frequently unreadable.  Therefore, they are displayed on
-- bearers so that the code can be understood and, if necessary, corrected.
local dc = function(text) return gsub(text, "[р╕нр║н]", "") end -- Discard bearer

local transform
function export.mono_form(text, script)

    local result = text

    if script == "Thai" then
        result = gsub(result, "р╣Н", "р╕Зр╕║")
        result = gsub(result, "([р╕Б-р╕о])р╕║", "р╕▒%1р╕║")
        result = gsub(result, "([р╕Б-р╕о])([^р╕░р╕▒р╕▓р╕┤р╕╡р╕║р╕╕р╕╣])", "%1р╕░%2")
        result = gsub(result, "([р╕Б-р╕о])([^р╕░р╕▒р╕▓р╕┤р╕╡р╕║р╕╕р╕╣])", "%1р╕░%2") -- twice
        result = gsub(result, "([р╕Б-р╕о])$", "%1р╕░")
        --		result = gsub(result, "([р╕Б-р╕о])([р╕▓р╕┤р╕╡р╕╕р╕╣])р╕▒", "%1%2")
        result = gsub(result, dc("([р╕Б-р╕о])([р╕▓р╕нр╕┤р╕нр╕╡р╕нр╕║р╕нр╕╕р╕нр╕╣])р╕нр╕▒"), "%1%2")
        result = gsub(result, "([р╣Ар╣В])([р╕Б-р╕о])([р╕░р╕▒])", "%1%2")
        result = gsub(result, "^р╕▒", "")
        result = gsub(result, "([%s%p])р╕▒", "%1")
        result = gsub(result, "р╕║", "")
    elseif script == "Laoo" then
        -- Calculating transform in argument list of gsub() fails!
        if not transform then
            transform = {
                {dc("р║нр╗Н"), dc("р║Зр║нр║║")}, {dc("([р║Б-р║о])р║нр║║"), dc("р║нр║▒%1р║нр║║")}, {dc("([р║Б-р║о])([^р║░р║нр║▒р║▓р║нр║┤р║нр║╡р║нр║║р║нр║╕р║нр║╣])"), "%1р║░%2"}, {dc("([р║Б-р║о])([^р║░р║нр║▒р║▓р║нр║┤р║нр║╡р║нр║║р║нр║╕р║нр║╣])"), "%1р║░%2"}, -- twice!
                {"([р║Б-р║о])$", "%1р║░"}, {dc("([р║Б-р║о])([р║▓р║нр║┤р║нр║╡р║нр║║р║нр║╕р║нр║╣])р║нр║▒"), "%1%2"}, {dc("([р╗Ар╗В])([р║Б-р║о])([р║░р║нр║▒])"), "%1%2"}, {dc("^р║нр║▒"), ""}, {dc("([%s%p])р║нр║▒"), "%1"}, {dc("р║нр║║"), ""}
            }
        end
        for _, v in ipairs(transform) do result = gsub(result, v[1], v[2]) end
    end

    return result
end

local function return_error(text) return error(("Unrecognised part: \"%s\""):format(text)) end

function export.tr(text, script, options)
    if type(text) == "table" then
        options = {}
        options.impl = text.args["impl"]
        options.variation = text.args["variation"] -- ID of variation: [Mymr: 1=Mon, 2=Old Shan, 3=New Shan]
        text, script = text.args[1], text.args[2]
    end
    if script == "Latn" then return text end
    if not s[script] then return nil end

    text = mw.ustring.lower(text)
    text = gsub(text, "[0-9%.,%-]", s[script])
    -- Compose patterns for processing onsets. 
    local letter = "[^" .. join[script] .. nukta .. "][" .. nukta .. "]?"
    local letter_pair = "(" .. letter .. ")(" .. letter .. ")"

    for word in mw.ustring.gmatch(text, "[a─Бi─лu┼лeoс╣Гkhgс╣Еcj├▒с╣нс╕Нс╣Зtdnpbmyrlс╕╖vs]+") do
        local word_conv, orig_word = {}, word
        word = gsub(word, "([a─Бi─лu┼лeo]с╣Г?)", "%1 ")
        word = gsub(word, " $", "")

        for syllable in mw.text.gsplit(word, " ") do
            if not match(syllable, "[a─Бi─лu┼лeoс╣Г]$") then syllable = syllable .. "a" .. kill[script] end
            syllable = gsub(syllable, "^([khgс╣Еcj├▒с╣нс╕Нс╣Зtdnpbmyrlс╕╖vs]*)([a─Бi─лu┼лeo])(с╣Г?)([реНрзНсЯСсА║р╖Кр╕║ЁСБЖсй║р║║]?)$", function(onset, vowel, coda, optJoin)
                if onset == "" then
                    onset = vowel
                    vowel = ""
                end
                if not c[script][onset] then
                    onset = gsub(onset, ".h", c[script])
                    onset = gsub(onset, ".", c[script])
                    -- Join pairs of consonants
                    onset = gsub(onset, letter_pair, "%1" .. join[script] .. "%2")
                    -- Join adjacent consonants that were in different pairs.
                    onset = gsub(onset, letter_pair, "%1" .. join[script] .. "%2")
                else
                    onset = c[script][onset]
                end

                return onset .. (v[script][vowel] or return_error(vowel)) .. c[script][coda] .. optJoin
            end)

            table.insert(word_conv, syllable)
        end
        word = table.concat(word_conv, "")
        if script == "Thai" then
            word = gsub(word, "(.)([р╣Ар╣В])", "%2%1")
        elseif script == "Mymr" then
            word = gsub(word, "сАДсА╣", "сАДсА║сА╣")
            word = gsub(word, "(сАДсА║сА╣)([сАБсАВсАДсАТсАХсАЭ])(сА▒?)сАм", "%1%2%3сАл")
            word = gsub(word, "сА╣[сАЪсАЫ]", {["сА╣сАЪ"] = "сА╗", ["сА╣сАЫ"] = "сА╝"}) -- these not need tall aa
            word = gsub(word, "^([сАБсАВсАДсАТсАХсАЭ])(сА▒?)сАм", "%1%2сАл")
            word = gsub(word, "([^сА╣])([сАБсАВсАДсАТсАХсАЭ])(сА▒?)сАм", "%1%2%3сАл")
            word = gsub(word, "([сАБсАВсАДсАТсАХсАЭ])(сА╣[сАА-сАбсА┐])(сА▒?)сАм", "%1%2%3сАл")
            word = gsub(word, "сА╣[сАЭсАЯ]", {["сА╣сАЭ"] = "сА╜", ["сА╣сАЯ"] = "сА╛"})
            word = gsub(word, "сАЙсА╣сАЙ", "сАК")
            word = gsub(word, "сАЮсА╣сАЮ", "сА┐")
            if not (options and options.variation) then
                -- Arg options should be optional, so nothing to do. 
            elseif options.variation == "1" then
                word = gsub(word, ".", variations.Mon)
                word = gsub(word, "сАнсА╢", "сАо") -- fix IM
            elseif options.variation == "2" then
                word = gsub(word, ".", variations.OldShan)
            elseif options.variation == "3" then
                word = gsub(word, ".", variations.OldShan)
                word = gsub(word, ".", variations.NewShan)
                word = gsub(word, "сА║" .. "сА║", "сА║") -- fix nga
            end
        elseif script == "Lana" then
            word = gsub(word, "сижсйа", "сйШ")
            word = gsub(word, "^([сигси┤си╡си╖сйЕ])(сйо?)сйг", "%1%2сйд")
            word = gsub(word, "([^сйа])([сигси┤си╡си╖сйЕ])(сйо?)сйг", "%1%2%3сйд")
            word = gsub(word, "([сигси┤си╡си╖сйЕ])(сйа[сиа-сйМсйФ])(сйо?)сйг", "%1%2%3сйд")
            word = gsub(word, "сйа[сйБсйГ]", {["сйасйБ"] = "сйХ", ["сйасйГ"] = "сйЦ"})
            word = gsub(word, "([син-си▒])сйасио", "%1сйЫ")
            word = gsub(word, "([си╖-си╛])сйаси╗", "%1сйЫ")
            word = gsub(word, "сйИсйасйИ", "сйФ")
        elseif script == "Beng" then
            word = gsub(word, "рз░рзН", "рз░" .. u(0x200d) .. "рзН") -- рз░рзН(v-) needs ZWJ to display correctly
        elseif script == "Sinh" then
            local js = join["Sinh"]
            word = gsub(word, "(" .. js .. ")([р╢║р╢╗])", u(0xdca, 0x200d) .. "%2")
            word = gsub(word, "[р╢Ър╢нр╢▒]" .. js .. "[р╢ор╢пр╢░р╖А]", sinh_cjct)
        elseif script == "Laoo" then
            word = gsub(word, "(.)([р╗Ар╗В])", "%2%1")
        end
        text = gsub(text, orig_word, word, 1)
    end
    local impl = options and options.impl or "yes"
    if impl == "no" then text = export.mono_form(text, script) end
    return text
end

return export
